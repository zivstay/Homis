# רשימת קניות מתקדמת (גרסה 2) - תיעוד מלא

## סקירה כללית
פיצ'ר רשימת הקניות המתקדם מאפשר לכל חברי הלוח לנהל **מספר רשימות קניות** במקביל. כל רשימה מכילה שם, תיאור, תאריך ופריטים עם תיאורים. בנוסף, קיימת אינטגרציה חכמה עם מערכת ההוצאות.

## שדרוגים בגרסה 2

### 🆕 תכונות חדשות:
1. **רשימות מרובות** - לא עוד רשימה אחת! כל לוח יכול להכיל מספר בלתי מוגבל של רשימות
2. **מידע נוסף לרשימה**:
   - שם רשימה
   - תיאור (לא חובה)
   - תאריך (לא חובה) - מועיל לקניות מתוכננות
3. **מידע נוסף לפריטים**:
   - תיאור לכל פריט (לא חובה)
4. **קישור להוצאות** - כפתור "💰 קניתי! הוסף הוצאה" שמעביר ישירות למסך הוספת הוצאה עם תיאור מוכן

## מבנה הפיצ'ר

### 1. Backend - PostgreSQL Tables

#### טבלת `shopping_lists` (חדש!)
מאחסנת רשימות קניות:
- `id` - מזהה ייחודי
- `board_id` - מזהה הלוח
- `name` - שם הרשימה
- `description` - תיאור הרשימה (אופציונלי)
- `date` - תאריך לרשימה (אופציונלי)
- `created_by` - מזהה המשתמש שיצר
- `created_at` - תאריך יצירה
- `updated_at` - תאריך עדכון
- `is_active` - האם הרשימה פעילה (soft delete)

#### טבלת `shopping_list_items` (מעודכן)
מאחסנת פריטים ברשימות:
- `id` - מזהה ייחודי
- `shopping_list_id` - מזהה הרשימה (קודם היה board_id)
- `item_name` - שם הפריט
- `description` - תיאור הפריט (חדש! אופציונלי)
- `is_completed` - האם הפריט הושלם
- `created_by` - מזהה המשתמש שיצר
- `created_at` - תאריך יצירה
- `updated_at` - תאריך עדכון
- `completed_at` - תאריך השלמה
- `completed_by` - מזהה המשתמש שהשלים

#### טבלת `shopping_list_quick_items` (מעודכן!)
מאחסנת פריטים מהירים (עד 20 ללוח):
- `id` - header key
- `board_id` - מזהה הלוח
- `item_name` - שם הפריט
- `icon` - אייקון לפריט (חדש! אופציונלי)
- `display_order` - סדר תצוגה
- `created_at` - תאריך יצירה
- `updated_at` - תאריך עריכה

### 2. Backend - API Endpoints (מעודכן!)

#### רשימות (Lists)
- **GET** `/api/boards/<board_id>/shopping-lists` - קבלת כל הרשימות של לוח
- **POST** `/api/boards/<board_id>/shopping-lists` - יצירת רשימה חדשה
  - Body: `{ "name": "שם", "description": "תיאור", "date": "2025-10-15" }`
- **PUT** `/api/boards/<board_id>/shopping-lists/<list_id>` - עדכון רשימה
- **DELETE** `/api/boards/<board_id>/shopping-lists/<list_id>` - מחיקת רשימה (soft delete)

#### פריטים (Items)
- **GET** `/api/boards/<board_id>/shopping-lists/<list_id>/items` - קבלת פריטים ברשימה
- **POST** `/api/boards/<board_id>/shopping-lists/<list_id>/items` - הוספת פריט
  - Body: `{ "item_name": "שם", "description": "תיאור" }`
- **PUT** `/api/boards/<board_id>/shopping-lists/<list_id>/items/<item_id>` - עדכון פריט
- **DELETE** `/api/boards/<board_id>/shopping-lists/<list_id>/items/<item_id>` - מחיקת פריט

#### פריטים מהירים (Quick Items) - מעודכן!
- **GET** `/api/boards/<board_id>/shopping-list/quick-items` - קבלת פריטים מהירים
- **PUT** `/api/boards/<board_id>/shopping-list/quick-items` - עדכון פריטים מהירים
  - Body: `[{ "name": "חלב", "icon": "🥛" }, { "name": "לחם", "icon": "🍞" }]`
  - תמיכה לאחור בפורמט ישן: `["חלב", "לחם"]`

### 3. Frontend - Component (מעודכן במלואו)

#### ShoppingListModal
קומפוננטה מודאלית עם 3 מצבים:
1. **תצוגת רשימות ופריטים** - מצב ראשי
2. **יצירת רשימה חדשה** - מודאל ליצירת רשימה
3. **הגדרת פריטים מהירים** - מודאל להגדרת 20 פריטים מהירים

**תכונות UI:**
- **טאבים** - ניווט בין רשימות שונות
- **כפתור "רשימה חדשה"** - יצירת רשימות נוספות
- **פריטים מהירים** - שורת כפתורים מהירים בראש עם אייקונים
- **הוספת פריט מורחבת** - שדה שם + שדה תיאור
- **כפתור "💰 קניתי! הוסף הוצאה"** - מעוגן לתחתית המסך
- **מחיקת רשימות** - לחיצה ארוכה על טאב
- **עריכת פריטים** - לחיצה ארוכה או כפתור ✏️
- **העברת פריטים** - כפתור ➡️ או בתפריט
- **בוחר אייקונים** - 60 אייקונים רלוונטיים לקניות

### 4. Integration - AddExpenseScreen (חדש!)

הוספנו תמיכה ב-`prefilledDescription` שמתקבל מ-navigation params:
- כשלוחצים על "קניתי! הוסף הוצאה", המשתמש מועבר למסך הוספת הוצאה
- התיאור מולא אוטומטית: "רשימת קניות - {שם הרשימה}"
- המשתמש יכול להמשיך למלא את שאר הפרטים (סכום, קטגוריה וכו')

## הרצת Migration

### הרצת Migration המלא
```bash
cd backend
python add_shopping_list_migration.py
```

ה-migration כולל הכל:
1. יוצר טבלת `shopping_lists`
2. מעביר נתונים קיימים מ-`shopping_list_items` (אם יש)
3. מוסיף עמודת `description` לפריטים
4. מוסיף עמודת `icon` לפריטים מהירים
5. מעדכן מבנה טבלת `shopping_list_items`
6. מסיר את העמודה הישנה `board_id`

**חשוב:** ה-migration שומר את כל הנתונים הקיימים! אם היו פריטים ברשימת הקניות, הם יועברו לרשימה חדשה בשם "רשימת קניות ראשית".

## הרשאות

- **READ** - כל חבר לוח יכול לצפות ברשימות
- **WRITE** - כל חבר לוח יכול ליצור רשימות, להוסיף פריטים, לעדכן ולמחוק
- **ADMIN** - רק מנהלי לוח יכולים להגדיר פריטים מהירים

## שימוש מלא

### יצירת רשימה חדשה
1. פתח את רשימות הקניות (כפתור 🛒)
2. לחץ על "+ רשימה חדשה"
3. מלא:
   - שם רשימה (חובה) - למשל: "קניות שבועיות", "ברביקיו של שבת"
   - תיאור (אופציונלי) - למשל: "חסרונות מהמקרר"
   - תאריך (אופציונלי) - למשל: "2025-10-15"
4. לחץ "צור רשימה"

### ניהול פריטים
1. **הוספת פריט רגיל**:
   - מלא שם פריט (למשל: "חלב")
   - מלא תיאור (אופציונלי) - למשל: "3%, בקרטון"
   - לחץ +

2. **הוספה מהירה**:
   - לחץ על אחד הפריטים המהירים
   - הפריט יתווסף ישירות

3. **סימון כהושלם**:
   - לחץ על הפריט
   - V ירוק יופיע והפריט יעבור למטה

4. **מחיקת פריט**:
   - לחץ על 🗑️ ליד הפריט
   - אשר מחיקה

### הוספת הוצאה מהרשימה
1. סיימת לקנות? לחץ על "💰 קניתי! הוסף הוצאה"
2. תועבר אוטומטית למסך הוספת הוצאה
3. התיאור כבר מולא: "רשימת קניות - {שם הרשימה}"
4. מלא סכום, בחר קטגוריה ושמור

### מחיקת רשימה
1. לחץ לחיצה ארוכה על הטאב של הרשימה
2. אשר מחיקה
3. כל הפריטים ברשימה יימחקו

### הגדרת פריטים מהירים (מנהלים בלבד)
1. לחץ על ⚙️ בפינה
2. **תמיד מופיעים** 10 מוצרים בסיסיים בתחילת הרשימה:
   - חלב 🥛, לחם 🍞, ביצים 🥚, גבינה 🧀, עגבניות 🍅
   - מלפפון 🥒, בננות 🍌, תפוחים 🍎, יוגורט 🥛, מים 🥤
3. אחרי המוצרים הבסיסיים - הפריטים המותאמים אישית שהוספת
4. עבור כל פריט:
   - ערוך את השם או השאר כמו שהוא
   - לחץ על כפתור האייקון ולבחר אייקון אחר
5. הוסף עד 20 פריטים נפוצים (לחץ "+ הוסף פריט מהיר")
6. לחץ "שמור"
7. הפריטים יופיעו עם האייקונים לכל חברי הלוח

## מבנה קבצים

### Backend (מעודכן)
- `backend/postgres_models.py` - הוספת מודל `ShoppingList`, עדכון `ShoppingListItem`
- `backend/app.py` - 8 endpoints חדשים/מעודכנים
- `backend/upgrade_shopping_lists_migration.py` - סקריפט migration חדש

### Frontend (מעודכן)
- `components/ShoppingListModal.tsx` - קומפוננטה מחודשת לחלוטין
- `screens/AddExpenseScreen.tsx` - תמיכה ב-prefilledDescription
- `screens/HomeScreen.tsx` - שילוב הכפתור

## דוגמאות שימוש

### תרחיש 1: קניות שבועיות
```
1. צור רשימה: "קניות שבועיות"
2. הוסף פריטים: חלב, לחם, ביצים...
3. לך לסופר
4. סמן פריטים שקנית
5. חזור הביתה
6. לחץ "קניתי! הוסף הוצאה"
7. מלא סכום: 350 ₪
8. בחר קטגוריה: מכולת
9. שמור
```

### תרחיש 2: ברביקיו מתוכנן
```
1. צור רשימה: "ברביקיו 15.10"
2. תאריך: 2025-10-15
3. תיאור: "ברביקיו עם חברים - 10 אנשים"
4. הוסף פריטים: בשר, פחמים, משקאות...
5. תיאור לפריט: "בשר: 3 ק"ג"
```

### תרחיש 3: פריטים מהירים
```
(למנהל לוח)
1. לחץ ⚙️
2. תמיד תראה 10 מוצרים בסיסיים בראש הרשימה
3. אם הוספת פריטים מותאמים - הם יופיעו אחריהם
4. ערוך, מחק או הוסף מוצרים נוספים
5. שמור

(לכל חברי הלוח)
1. לחץ על "חלב" - נוסף ישירות!
2. לחץ על "לחם" - נוסף ישירות!
3. התחל להקליד "בי..." - מופיע "ביצים" בהשלמה אוטומטית
```

### תרחיש 4: העברה מרובה
```
1. יש לך 15 פריטים ברשימת "קניות שבועיות"
2. רוצה להעביר 7 פריטים לרשימה "ברביקיו"
3. לחץ "הבחר פריטים"
4. סמן את 7 הפריטים הרצויים
5. לחץ "העבר (7)"
6. בחר "ברביקיו" או צור רשימה חדשה
7. כל 7 הפריטים עוברים ביחד!
```

## שיפורים נוספים (גרסה 2.1)

### 🆕 תכונות שנוספו:
1. **השלמה אוטומטית** - בעת הקלדת פריט, המערכת מציעה התאמות מהפריטים המהירים
2. **בחירה מרובה של פריטים**:
   - כפתור "הבחר פריטים" מעל הרשימה
   - אפשרות לבחור מספר פריטים ביחד
   - כפתורים "הכל" ו"נקה" לבחירה/ניקוי מהירה
   - כפתור "העבר (X)" להעברת כל הפריטים הנבחרים לרשימה אחרת
3. **מוצרים בסיסיים כברירת מחדל**:
   - 10 מוצרים נפוצים תמיד מופיעים בתחילת רשימת הפריטים המהירים
   - הפריטים המותאמים אישית מופיעים אחריהם
   - ניתן לערוך, למחוק או להוסיף פריטים נוספים
4. **אינדיקטור השלמת רשימה**:
   - סימון ✓ מוצג בטאב של רשימה כשכל הפריטים מסומנים כהושלמו
   - הסימון נשמר ב-DB ומתעדכן אוטומטית בכל שינוי
   - נראה בכל הטאבים גם כשלא נמצאים בתוך הרשימה

## שיפורים עתידיים (אופציונלי)

- ✅ רשימות מרובות
- ✅ שדות נוספים (תיאור, תאריך)
- ✅ אינטגרציה עם הוצאות
- ✅ השלמה אוטומטית
- ✅ בחירה מרובה
- ✅ פריטים בסיסיים כברירת מחדל
- ✅ אינדיקטור השלמת רשימה
- 🔜 כמויות לפריטים
- 🔜 שיתוף רשימה בווטסאפ
- 🔜 שכפול רשימה
- 🔜 תבניות רשימות (שבועי, חודשי)
- 🔜 היסטוריית רשימות

## השוואה בין גרסה 1 לגרסה 2

| תכונה | גרסה 1 | גרסה 2 |
|-------|---------|---------|
| מספר רשימות | 1 | בלתי מוגבל |
| שם לרשימה | ❌ | ✅ |
| תיאור לרשימה | ❌ | ✅ |
| תאריך לרשימה | ❌ | ✅ |
| תיאור לפריט | ❌ | ✅ |
| אינטגרציה עם הוצאות | ❌ | ✅ |
| פריטים מהירים | ✅ | ✅ (ללא שינוי) |

## Troubleshooting

### Migration נכשל
```bash
# בדוק חיבור ל-DB
python backend/test_db_connection.py

# הרץ שוב
python backend/upgrade_shopping_lists_migration.py
```

### שגיאות API
- ודא שה-token תקין
- בדוק הרשאות לגישה ללוח
- בדוק logs בשרת

### רשימות לא מופיעות
- ודא שהרצת את upgrade migration
- בדוק שיש רשימות פעילות (is_active = TRUE)
- רענן את הדף

### הוצאה לא נוספת
- ודא שהתיאור הועבר נכון
- בדוק שיש board נבחר
- בדוק logs בקונסול

## סיכום

גרסה 2 של רשימת הקניות הופכת אותה לכלי מתקדם וחכם לניהול קניות:
- **גמישות** - רשימות מרובות לכל מטרה
- **אינפורמטיביות** - מידע עשיר על רשימות ופריטים
- **אינטגרציה** - קישור ישיר למערכת ההוצאות
- **נוחות** - פריטים מהירים וממשק אינטואיטיבי

🎉 תהנו מרשימת הקניות החדשה!

