# מערכת הזמנות ללוחות הוצאות - Homis

## תיאור הפיצ'ר
מערכת הזמנות חכמה המאפשרת הזמנת משתמשים חדשים ללוחות הוצאות עם שליחת מייל הזמנה יפה, הורדת אפליקציה וחיבור אוטומטי לאחר רישום.

## איך זה עובד

### 1. הזמנת חבר חדש ללוח

כאשר מנהל לוח מזמין משתמש שאין לו עדיין חשבון במערכת:

1. **יצירת הזמנה**: המערכת יוצרת רשומת הזמנה בבסיס הנתונים עם טוקן ייחודי
2. **שליחת מייל**: נשלח מייל הזמנה יפה ומפורט עם:
   - פרטי הלוח והמזמין
   - הסבר על האפליקציה
   - הוראות הורדה ברורות
   - קישור לעמוד הורדת האפליקציה
   - תוקף של 7 ימים

### 2. מידע המייל הנשלח

המייל כולל:
- **עיצוב יפה ומקצועי** בעברית עם לוגו Homis
- **פרטי ההזמנה**: שם המזמין ושם הלוח
- **הסבר על היתרונות** של האפליקציה
- **הוראות הורדה מפורטות** צעד אחר צעד
- **קישור לעמוד הורדה** עם פרטי ההזמנה
- **מידע על תוקף** ההזמנה (7 ימים)

### 3. עמוד הורדת האפליקציה

כשהמוזמן לוחץ על הקישור במייל:
- מגיע לעמוד הורדה יפה ומעוצב
- רואה את פרטי ההזמנה שלו
- מקבל הוראות ברורות להורדה ורישום
- יש קישורים ישירים לחנויות האפליקציות

### 4. רישום באפליקציה

המערכת תומכת ברישום רגיל עם זיהוי הזמנות:

#### רישום באפליקציה הנייד
- המשתמש מוריד את האפליקציה מחנות האפליקציות
- נרשם עם המייל שקיבל את ההזמנה
- המערכת זוהה אוטומטית את ההזמנות הממתינות
- המשתמש מתחבר אוטומטית לכל הלוחות הרלוונטיים

## Endpoints חדשים

### 1. עמוד הורדת האפליקציה
```
GET /download?invitation={invitation_token}
```

**תיאור:** עמוד HTML יפה ומעוצב להורדת האפליקציה עם פרטי ההזמנה

**פרמטרים:**
- `invitation` (optional): טוקן ההזמנה לקבלת פרטים מותאמים אישית

**תגובה:** עמוד HTML מעוצב בעברית עם:
- פרטי ההזמנה (אם סופק טוקן)
- הוראות הורדה צעד אחר צעד
- קישורים לחנויות האפליקציות
- עיצוב responsive ומותאם לנייד

### 2. קבלת מידע על הזמנה
```
GET /api/auth/invitation/{invitation_token}
```

**תגובה מוצלחת:**
```json
{
  "valid": true,
  "invitation": {
    "id": "uuid",
    "email": "user@example.com",
    "role": "member",
    "expires_at": "2024-01-01T00:00:00Z",
    "created_at": "2023-12-25T00:00:00Z"
  },
  "board": {
    "id": "board-uuid",
    "name": "לוח המשפחה",
    "description": "ניהול הוצאות המשפחה",
    "currency": "ILS"
  },
  "inviter": {
    "name": "יוסי כהן"
  }
}
```

### 2. רישום עם הזמנה
```
POST /api/auth/register-with-invitation
```

**פרמטרים:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "first_name": "שם פרטי",
  "last_name": "שם משפחה",
  "invitation_token": "invitation-token-uuid",
  "accepted_terms": true,
  "terms_accepted_at": "2024-01-01T00:00:00Z"
}
```

**תגובה מוצלחת:**
```json
{
  "message": "User registered successfully and joined 2 board(s)",
  "user_id": "user-uuid",
  "accepted_terms": true,
  "terms_accepted_at": "2024-01-01T00:00:00Z",
  "terms_version": "1.0",
  "boards_joined": [
    {
      "board_id": "board-uuid-1",
      "board_name": "לוח המשפחה",
      "role": "member"
    },
    {
      "board_id": "board-uuid-2", 
      "board_name": "לוח החברים",
      "role": "member"
    }
  ]
}
```

## שינויים בקוד

### 1. AuthManager - backend/auth.py
- **פונקציה חדשה**: `send_board_invitation_email()` - שליחת מייל הזמנה מעוצב
- מנצלת את שירות Brevo הקיים לשליחת מיילים

### 2. PostgreSQLDatabaseManager - backend/postgres_models.py
- **פונקציה חדשה**: `get_pending_invitations_by_email()` - קבלת הזמנות ממתינות לפי אימייל

### 3. Board Invitation Endpoint - backend/app.py
- **עדכון**: `/api/boards/{board_id}/members` (POST) - עכשיו שולח מייל הזמנה למשתמשים חדשים
- **חדש**: `/api/auth/invitation/{token}` (GET) - קבלת מידע על הזמנה
- **חדש**: `/api/auth/register-with-invitation` (POST) - רישום עם הזמנה

### 4. Registration Process - backend/app.py
- **עדכון**: `/api/auth/register` (POST) - עכשיו בודק הזמנות ממתינות ומחבר אוטומטי

## הגדרות נדרשות

### משתני סביבה
```bash
# שירות מייל Brevo
BREVO_API_KEY=your_brevo_api_key

# כתובת האפליקציה (לקישורים במייל)
APP_URL=https://homis-app.com
```

### קובץ הגדרות
```python
# backend/config.py
class Config:
    # ... הגדרות קיימות ...
    APP_URL = os.environ.get('APP_URL', 'https://homis-app.com')
```

## דוגמת שימוש

### מנהל לוח מזמין משתמש חדש:
1. נכנס להגדרות הלוח באפליקציה
2. לוחץ על "הזמן חבר"
3. מזין כתובת אימייל
4. המערכת שולחת מייל הזמנה אוטומטית

### המוזמן מקבל המייל והצטרף:
1. מקבל מייל הזמנה יפה ומפורט עם הוראות ברורות
2. לוחץ על הקישור במייל
3. מגיע לעמוד הורדה מעוצב עם פרטי ההזמנה שלו
4. מוריד את האפליקציה מחנות האפליקציות
5. נרשם באפליקציה עם המייל שקיבל את ההזמנה
6. הלוח מופיע לו אוטומטית (וגם כל הזמנה נוספת שיש לו)

## יתרונות המערכת

1. **חוויית משתמש מושלמת** - מהמייל עד להורדת האפליקציה ורישום אוטומטי
2. **מיילים מקצועיים** - הזמנות יפות ומפורטות עם הוראות ברורות
3. **עמוד הורדה אטרקטיבי** - נחיתה מעוצבת עם פרטי ההזמנה האישיים
4. **טיפול חכם בהזמנות מרובות** - אם למשתמש יש מספר הזמנות, הוא מתחבר לכולן
5. **תמיכה בפלטפורמות** - קישורים ישירים לחנויות האפליקציות
6. **אבטחה** - טוקנים ייחודיים עם תוקף מוגבל
7. **מותאם לישראל** - עברית מלאה עם עיצוב RTL

## בדיקות ואבטחה

המערכת כוללת בדיקות אבטחה:
- וידוא תוקף ההזמנה (7 ימים)
- התאמת אימייל להזמנה
- בדיקה שההזמנה לא נוצלה כבר
- טיפול בשגיאות ומצבי קיצון

## מגבלות

- הזמנה תקפה למשך 7 ימים
- כל הזמנה ניתנת לשימוש פעם אחת בלבד
- נדרש שירות מייל פעיל (Brevo)
- אימייל ההזמנה חייב להתאים לאימייל הרישום